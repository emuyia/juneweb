{% extends "base.html" %}

{% block content %}

<div class="d-flex pb-1">
    {% if check_if_admin() %}
    <div class="ps-1">
        <a class="btn btn-primary btn-sm" href="{{ url_for('manage_post') }}">Add</a>
    </div>
    {% endif %}

    <div class="ms-auto d-flex">
        <div class="dropdown ps-1">
          <button class="btn btn-secondary dropdown-toggle btn-sm" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false">Filter</button>
          <ul class="dropdown-menu dropdown-menu-end" id="tag-select" aria-labelledby="tagDropdown">
            {% for tag in tags %}
              <li>
                <a class="dropdown-item" id="{{tag.name}}">
                    <input class="form-check-input" type="checkbox" value="{{tag.name}}" {% if tag.name in selected_tags %}checked{% endif %}>
                    <label class="form-check-label">#{{tag.name}}</label>
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
    </div>

</div>

<script>
document.querySelectorAll('.dropdown-item').forEach(item => {
  item.addEventListener('click', function() {
    let selectedTags = window.location.href.split('=')[1] ? window.location.href.split('=')[1].split(',') : [];
    if (selectedTags.includes(this.id)) {
      selectedTags = selectedTags.filter(tag => tag !== this.id);
    } else {
      selectedTags.push(this.id);
    }
    window.location.href = `?tags=${selectedTags.join(',')}`;
  });
});

function filterPostsByTags() {
    let selectedTags = Array.from(document.querySelectorAll('#tag-select input:checked')).map(input => input.value);
    window.location.href = `?tags=${selectedTags.join(',')}`;
}
</script>

{% if posts %}
    <div class="row ps-2 pe-2">
        {% for post in posts %}
            <div class="col-md-4 col-lg-4 g-2">
                <div class="card text-white" style="max-height:300px;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="{{ url_for('view_post', post_id=post.id) }}">{{ post.title }}</a>
                        </h5>
                        <div class="miniature-view">
                          <p class="card-text">{{ post.content | safe }}</p>
                        </div>
                    </div>
                    <div class="card-footer text-muted info d-flex justify-content-between">
                        <div>
                            <p>posted by <span class="author">{{ post.author }}</span></p>
                            <p style="font-size:10px;color:gray;">on {{ post.date_posted.strftime('%d-%m-%Y at %H:%M') if post.date_posted else '' }}</p>
                        </div>
                        <div>
                            {% for tag in post.tags %}
                                <a href="{{ url_for('blog', tags=tag.name) }}" class="text-end d-inline-block ms-1">#{{ tag.name }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>No posts found.</p>
{% endif %}

{% endblock %}
